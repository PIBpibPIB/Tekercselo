unit Buttons;
uses
  PWM,
  feedrate,
  Display,
  Declarations;

procedure Buttons_interrupt;
procedure Buttons_mainloop;

//display photo:  ac:display

//------------------------------------------------------------------------------
//
//                 UP
//  SELECT  LEFT       RIGHT RST
//                DOWN
//
//                 2
//  0       1          4     5
//                 3
//------------------------------------------------------------------------------
implementation
var
  INPUT   : byte;
const
  SELECT     = 0;
  LEFT       = 1;
  UP         = 2;
  DOWN       = 3;
  RIGHT      = 4;
  STOP       = 5;

  ENDSTOP_R   = 6;
  ENDSTOP_L   = 7;

//------------------------------------------------------------------------------
function isbetween(val, min, max : word) : boolean;
begin
  if val > max then begin result := false; exit; end;
  if val < min then begin result := false; exit; end;
  result := true;
end;
//------------------------------------------------------------------------------
procedure Buttons_interrupt;
var
  adval     : word;
  k         : word;
begin
  adval :=  ADC_Get_Sample(8);
  adval :=  ADC_Get_Sample(8);
  INPUT := 0;

  if isbetween(adval,    0,  298) then INPUT.RIGHT  := 1;
  if isbetween(adval,  323,  794) then INPUT.UP     := 1;
  if isbetween(adval,  993, 1588) then INPUT.DOWN   := 1;
  if isbetween(adval, 1638, 2308) then INPUT.LEFT   := 1;
  if isbetween(adval, 2730, 3127) then INPUT.SELECT := 1;

  INPUT.STOP      := BUTTON_STOP;
  INPUT.ENDSTOP_R := ENDSTOP_RIGHT;
  INPUT.ENDSTOP_L := ENDSTOP_LEFT;

  //Button edge detection
  k := PORTD xor INPUT_LS;
  if k > 0 then
  begin
    //Edge was detected
    for i := 0 to 7 do
    begin
      if (k.i = 1) and (INPUT.i = 0) then
        BUTTONFLAGS.i := 1;
    end;
  end;
  INPUT_LS := INPUT;

end;
//------------------------------------------------------------------------------
procedure Buttons_mainloop;
var
  wi : word;
  bi : byte;
begin
  if BUTTONFLAGS > 0 then
  begin
    for i := 0 to 7 do
    begin
      if BUTTONFLAGS.i = 1 then
      begin
        case i of
          //--------------------------------------------------------------
          SELECT :  //D.0
          begin
            DIR := not DIR;
          end;
          //--------------------------------------------------------------
          LEFT :    //D.1
          begin
          end;
          //--------------------------------------------------------------
          UP :      //D.2
          begin
            wi := Feedrate_Get;
            wi := wi + 10;
            Feedrate_Set(wi);
            
            LCD_refreshvalues;
          end;
          //--------------------------------------------------------------
          DOWN :    //D.3
          begin
            wi := Feedrate_Get;
            if wi > 10 then
            begin
              wi := wi - 10;
              Feedrate_Set(wi);
            end;
            
            LCD_refreshvalues;
          end;
          //--------------------------------------------------------------
          RIGHT :
          begin
            bi := PWM_Get;
          end;
          //--------------------------------------------------------------
          STOP :         //D5
          begin
            liCounter := 0;
            LCD_refreshvalues;
          end;
          //--------------------------------------------------------------
          ENDSTOP_R :   //D6
          begin
            DIR := not DIR;
          end;
          //--------------------------------------------------------------
          ENDSTOP_L :   //D7
          begin
            DIR := not DIR;
          end;
          //--------------------------------------------------------------
        end;

        BUTTONFLAGS.i := 0;
      end;
    end;
  end;
end;
//------------------------------------------------------------------------------
end.
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------